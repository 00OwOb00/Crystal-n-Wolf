<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°´æ™¶èˆ‡ç‹¼ Crystal & Wolf</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Allura&family=Cormorant+Garamond:wght@400;600&family=Press+Start+2P&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/DRACOLoader.js"></script>

    <script src="./data/crystalsText.js"></script>
    <script src="./data/wolfData.js"></script>

    <style>
        :root {
            --gold: #D4AF37;
            --pixel-font: 'Press Start 2P', cursive;
            --serif-font: 'Cormorant Garamond', serif;
        }

        body, html { margin: 0; overflow: hidden; background: #050505; font-family: var(--serif-font); color: #fff; }
        
        /* èƒŒæ™¯èˆ‡ç•«å¸ƒ */
        #canvas-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; transition: width 1s ease; }
        body.result-mode #canvas-wrapper { width: 60%; }

        /* UI å±¤ */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .pointer-auto { pointer-events: auto; }

        /* é ‚éƒ¨å°èˆª */
        .top-bar { position: absolute; width: 100%; padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; }
        .logo { font-family: 'Allura', cursive; font-size: 2rem; color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
        
        /* éŸ³æ¨‚æ§åˆ¶ */
        .audio-btn { background: none; border: 1px solid var(--gold); color: var(--gold); padding: 5px 10px; cursor: pointer; border-radius: 5px; font-size: 0.8rem; }

        /* ä¸­å¤®å€åŸŸï¼šå°ç‹¼èˆ‡æŒ‰éˆ• */
        #center-stage {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            display: flex; flex-direction: column; align-items: center; gap: 20px;
            transition: opacity 0.5s;
        }

        /* åƒç´ å°ç‹¼ç•«å¸ƒ */
        #wolf-canvas {
            width: 160px; height: 160px;
            image-rendering: pixelated; /* é—œéµï¼šè®“åƒç´ åœ–ä¸æ¨¡ç³Š */
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.2));
            cursor: pointer;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .cta-button {
            background: rgba(0,0,0,0.6); border: 2px solid var(--gold); color: var(--gold);
            padding: 15px 30px; font-family: var(--serif-font); font-size: 1.3rem; letter-spacing: 2px;
            cursor: pointer; transition: all 0.3s; backdrop-filter: blur(5px);
            display: flex; align-items: center; gap: 10px;
        }
        .cta-button:hover { background: var(--gold); color: #000; box-shadow: 0 0 20px var(--gold); }

        /* è’è—å¤¾æŒ‰éˆ• */
        .wardrobe-btn {
            margin-top: 10px; font-family: var(--pixel-font); font-size: 0.7rem; 
            color: #aaa; background: none; border: none; cursor: pointer; text-decoration: underline;
        }
        .wardrobe-btn:hover { color: #fff; }

        /* æ¯æ—¥çå‹µé€šçŸ¥ */
        #reward-toast {
            position: absolute; top: -50px; opacity: 0; background: var(--gold); color: #000;
            padding: 10px 20px; border-radius: 20px; font-family: var(--pixel-font); font-size: 0.8rem;
            transition: all 0.5s; pointer-events: none; white-space: nowrap;
        }
        #reward-toast.show { top: -80px; opacity: 1; }

        /* è¼‰å…¥ç•«é¢ */
        #loading-screen {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: var(--gold); text-align: center; pointer-events: none; transition: opacity 0.5s;
        }

        /* è’è—å¤¾ Modal */
        #wardrobe-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 100; align-items: center; justify-content: center;
        }
        .wardrobe-content {
            background: #111; border: 2px solid var(--gold); width: 90%; max-width: 600px;
            height: 80vh; padding: 20px; border-radius: 10px; display: flex; flex-direction: column;
            color: #fff; font-family: var(--serif-font);
        }
        .wardrobe-tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { background: #333; border: none; color: #aaa; padding: 8px 15px; cursor: pointer; font-family: var(--pixel-font); font-size: 0.6rem; }
        .tab-btn.active { background: var(--gold); color: #000; }
        
        .wardrobe-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; 
            overflow-y: auto; flex: 1; padding: 10px; background: #000; border: 1px solid #333;
        }
        .wardrobe-item {
            width: 50px; height: 50px; border: 1px solid #444; cursor: pointer; position: relative;
            image-rendering: pixelated; display: flex; justify-content: center; align-items: center;
        }
        .wardrobe-item.locked { opacity: 0.3; cursor: not-allowed; background: #222; }
        .wardrobe-item.active { border: 2px solid var(--gold); }
        .color-dot { width: 10px; height: 10px; border-radius: 50%; position: absolute; bottom: 2px; right: 2px; border: 1px solid #fff; }

        /* çµæœé¢æ¿ */
        #result-panel {
            position: absolute; right: 0; top: 0; width: 40%; height: 100%; background: #fff;
            transform: translateX(100%); transition: transform 0.8s ease; color: #333;
            padding: 50px; box-sizing: border-box; overflow-y: auto; display: flex; flex-direction: column;
        }
        body.result-mode #result-panel { transform: translateX(0); }
        .crystal-name { font-size: 2.5rem; font-weight: bold; margin-bottom: 10px; }
        .crystal-theme { color: var(--gold); font-family: 'Allura', cursive; font-size: 2rem; }
        
        /* RWD */
        @media (max-width: 768px) {
            body.result-mode #canvas-wrapper { width: 100%; height: 40vh; }
            #result-panel { width: 100%; height: 60vh; top: auto; bottom: 0; transform: translateY(100%); }
            body.result-mode #result-panel { transform: translateY(0); }
            #center-stage { width: 90%; }
            #wolf-canvas { width: 120px; height: 120px; }
        }
    </style>
</head>
<body>
    <audio id="bgm" loop>
        <source src="./music/bgm.mp3" type="audio/mpeg">
    </audio>

    <div id="canvas-wrapper"></div>

    <div id="ui-layer">
        <div class="top-bar pointer-auto">
            <div class="logo">Crystal & Wolf</div>
            <button class="audio-btn" onclick="toggleAudio()">ğŸµ Music: OFF</button>
        </div>

        <div id="loading-screen">
            <h3>æ­£åœ¨å‡èšæ˜Ÿé›²...</h3>
            <div id="loading-text">0%</div>
        </div>

        <div id="center-stage" class="pointer-auto" style="display:none;">
            <div id="reward-toast">ç²å¾—æ–°é…ä»¶ï¼âœ¨</div>
            
            <canvas id="wolf-canvas" width="64" height="64" title="é»æ“Šæ›è£"></canvas>
            
            <button class="cta-button" onclick="startJourney()">
                <span>âœ¦ ä»Šå¤©è¦å°ˆæ³¨ä»€éº¼ï¼Ÿ</span>
            </button>
            
            <button class="wardrobe-btn" onclick="openWardrobe()">ğŸ’ æ‰“é–‹è¡£æ«ƒ (æ”¶è—: <span id="collection-count">0</span>)</button>
        </div>

        <div id="result-panel" class="pointer-auto">
            <div id="panel-content"></div>
            <button class="cta-button" style="margin-top:auto; width:100%; justify-content:center;" onclick="resetApp()">å†æŠ½ä¸€å¼µ</button>
        </div>
    </div>

    <div id="wardrobe-modal">
        <div class="wardrobe-content pointer-auto">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0;">å°ç‹¼çš„è¡£æ«ƒ</h3>
                <button onclick="closeWardrobe()" style="background:none; border:none; color:#fff; cursor:pointer;">âœ•</button>
            </div>
            <div class="wardrobe-tabs" id="wardrobe-tabs">
                </div>
            <div class="wardrobe-grid" id="wardrobe-grid">
                </div>
        </div>
    </div>

    <script>

        function updateLoading(loaded, total) {
    const percent = Math.floor((loaded / total) * 100);
    const text = document.getElementById('loading-text');
    if (text) text.innerText = `${percent}%`;

    if (loaded >= total) {
        const loading = document.getElementById('loading-screen');
        if (loading) loading.style.opacity = 0;

        const stage = document.getElementById('center-stage');
        stage.style.display = 'flex';
        setTimeout(() => stage.style.opacity = 1, 300);
    }
}

        // --- å…¨åŸŸè®Šæ•¸ ---
        function setupModelInNebula(model, x, y, z, data, index) {
    model.position.set(x, y, z);

    // ç¸®æ”¾
    const scale = 0.5 + Math.random() * 0.5;
    model.scale.set(scale, scale, scale);

    model.userData = { index, data };
    crystals.push(model);
    nebulaGroup.add(model);
}
        let scene, camera, renderer, controls;
        let nebulaGroup = new THREE.Group();
        let crystals = []; // å­˜æ”¾æ‰€æœ‰ 3D æ°´æ™¶ç‰©ä»¶
        let currentCrystal = null; // ç•¶å‰å±•ç¤ºçš„æ°´æ™¶
        let isResultMode = false;
        let audioPlaying = false;

        // å°ç‹¼ç‹€æ…‹
        let wolfState = {
            hat: { id: 0, color: 0 }, // 0 ä»£è¡¨æ²’ç©¿/åˆå§‹
            top: { id: 0, color: 0 },
            bottom: { id: 0, color: 0 },
            shoes: { id: 0, color: 0 },
            float: { id: 0, color: 0 },
            inventory: [] // å­˜æ”¾å·²è§£é–çš„é…ä»¶å­—ä¸² "type_id_colorIndex"
        };

        // --- 1. åˆå§‹åŒ–èˆ‡ 3D å ´æ™¯ ---
        function init() {
            // Three.js Setup
            const container = document.getElementById('canvas-wrapper');
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x050505, 0.02); // éœ§æ°£æ•ˆæœ

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 25;

            renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // æ•ˆèƒ½å„ªåŒ–
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.outputEncoding = THREE.sRGBEncoding;
            container.appendChild(renderer.domElement);

            // ç‡ˆå…‰
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
            dirLight.position.set(10, 20, 10);
            scene.add(dirLight);
            const pointLight = new THREE.PointLight(0xD4AF37, 2, 50); // é‡‘è‰²é»å…‰
            pointLight.position.set(0, 0, 0);
            scene.add(pointLight);

            // æ§åˆ¶å™¨
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 0.5;
            controls.enableZoom = true;
            controls.maxDistance = 60;
            controls.minDistance = 5;

            // è¼‰å…¥æ°´æ™¶æ˜Ÿé›²
            loadCrystalsNebula();

            // åˆå§‹åŒ–å°ç‹¼ç³»çµ±
            initWolfSystem();
            checkDailyReward();

            // å‹•ç•«å¾ªç’°
            animate();
            
            window.addEventListener('resize', onWindowResize);
        }

        // --- 2. è¼‰å…¥æ°´æ™¶æ˜Ÿé›² (GLTF + Draco) ---
function loadCrystalsNebula() {
    const dracoLoader = new THREE.DRACOLoader();
    
    // --- é—œéµä¿®æ­£ï¼šä½¿ç”¨ Google è¨—ç®¡çš„ Draco è§£ç¢¼å™¨è·¯å¾‘ ---
    // é€™è£¡å¿…é ˆæŒ‡å‘åŒ…å« .js å’Œ .wasm æª”æ¡ˆçš„è³‡æ–™å¤¾
    dracoLoader.setDecoderPath('https://www.gstatic.com/draco/versioned/decoders/1.4.3/');

    const loader = new THREE.GLTFLoader();
    loader.setDRACOLoader(dracoLoader);

    let loadedCount = 0;
    const crystalsArray = Object.values(window.crystalsData);
    const total = crystalsArray.length;
    
    console.log(`é–‹å§‹è§£ç¢¼ä¸¦è¼‰å…¥ ${total} é¡†æ°´æ™¶...`);

    // é€™è£¡å»ºè­°å…ˆå°‡ Object è½‰ç‚º Array è™•ç† (å¦‚æœ crystalsData æ˜¯ç‰©ä»¶æ ¼å¼)
    const dataEntries = Object.entries(window.crystalsData);

    dataEntries.forEach(([key, data]) => {
        const index = parseInt(key);
        const radius = 10 + Math.random() * 15;
        const theta = Math.random() * Math.PI * 2;
        const phi = Math.acos((Math.random() * 2) - 1);
        
        const x = radius * Math.sin(phi) * Math.cos(theta);
        const y = radius * Math.sin(phi) * Math.sin(theta);
        const z = radius * Math.cos(phi);

        const filename = data.modelFile || 'default.glb';
        const path = `./models/${filename}`;
        
        loader.load(path, (gltf) => {
            const model = gltf.scene;
            setupModelInNebula(model, x, y, z, data, index); 
            loadedCount++;
            updateLoading(loadedCount, total);
        }, undefined, (err) => {
            console.warn(`[è·³é] ç„¡æ³•è¼‰å…¥æˆ–è§£ç¢¼æ¨¡å‹: ${filename}ï¼Œé€™å¯èƒ½æ˜¯è·¯å¾‘æˆ–æ ¼å¼å•é¡Œã€‚`, err);
            
            // å³ä½¿å‡ºéŒ¯ä¹Ÿç•«ä¸€å€‹å°æ–¹å¡Šä»£æ›¿ï¼Œç¢ºä¿é€²åº¦æ¢æœƒå‹•
            const geo = new THREE.BoxGeometry(0.3, 0.3, 0.3);
            const mat = new THREE.MeshStandardMaterial({ color: 0x444444 });
            const mesh = new THREE.Mesh(geo, mat);
            setupModelInNebula(mesh, x, y, z, data, index);
            
            loadedCount++;
            updateLoading(loadedCount, total);
        });
    });
    
    scene.add(nebulaGroup);
}
        // --- 3. å°ç‹¼é¤Šæˆç³»çµ± (Canvas) ---
        
        function initWolfSystem() {
            // è®€å–å­˜æª”
            const savedData = localStorage.getItem('wolfData');
            if (savedData) {
                const parsed = JSON.parse(savedData);
                wolfState.inventory = parsed.inventory || [];
                // æ¢å¾©ä¸Šæ¬¡ç©¿è‘— (å¦‚æœæœ‰)
                if(parsed.wearing) Object.assign(wolfState, parsed.wearing);
            } else {
                // åˆå§‹è´ˆé€ä¸€äº›åŸºæœ¬æ¬¾
                wolfState.inventory = ['top_1_0', 'bottom_1_0'];
                wolfState.top = { id: 1, color: 0 };
                wolfState.bottom = { id: 1, color: 0 };
            }
            
            updateCollectionCount();
            drawWolf();
        }

        function checkDailyReward() {
            const lastDraw = localStorage.getItem('lastDrawDate');
            const today = new Date().toDateString();

            if (lastDraw !== today) {
                // æ˜¯æ–°çš„ä¸€å¤©ï¼Œç™¼æ”¾çå‹µ
                giveRandomItem();
                localStorage.setItem('lastDrawDate', today);
                
                // é¡¯ç¤ºå‹•ç•«
                const toast = document.getElementById('reward-toast');
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 3000);
            }
        }

        function giveRandomItem() {
            // å¾æ‰€æœ‰çµ„åˆä¸­éš¨æ©ŸæŠ½å–
            const types = ['hat', 'top', 'bottom', 'shoes', 'float'];
            const type = types[Math.floor(Math.random() * types.length)];
            const count = window.wolfParts[type].count;
            const styleId = Math.floor(Math.random() * count) + 1; // 1~6
            const colorIdx = Math.floor(Math.random() * window.wolfColors.length); // 0~9
            
            const itemKey = `${type}_${styleId}_${colorIdx}`;
            
            if (!wolfState.inventory.includes(itemKey)) {
                wolfState.inventory.push(itemKey);
                saveWolfData();
                document.getElementById('reward-toast').innerText = `ç²å¾—æ–°è£å‚™ï¼š${window.wolfColors[colorIdx].name}${window.wolfParts[type].label}ï¼âœ¨`;
            } else {
                // å¦‚æœé‡è¤‡ï¼Œç°¡å–®é‡è©¦ä¸€æ¬¡æˆ–è€…ç®—é‹æ°£ä¸å¥½ (é€™è£¡ç‚ºäº†æ¼”ç¤ºï¼Œæˆ‘å€‘å…è¨±é‡è¤‡ä½†ä¸å¢åŠ )
                document.getElementById('reward-toast').innerText = `ä»Šå¤©æ²’æœ‰ç™¼ç¾æ–°æ±è¥¿...`;
            }
        }

        function saveWolfData() {
            const dataToSave = {
                inventory: wolfState.inventory,
                wearing: {
                    hat: wolfState.hat,
                    top: wolfState.top,
                    bottom: wolfState.bottom,
                    shoes: wolfState.shoes,
                    float: wolfState.float
                }
            };
            localStorage.setItem('wolfData', JSON.stringify(dataToSave));
            updateCollectionCount();
        }

        function updateCollectionCount() {
            document.getElementById('collection-count').innerText = wolfState.inventory.length;
        }

        // --- æ ¸å¿ƒï¼šç¹ªè£½å°ç‹¼ ---
        function drawWolf() {
            const canvas = document.getElementById('wolf-canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, 64, 64);

            // ç¹ªåœ–é †åºï¼šç´ é«” -> è¤²å­ -> é‹å­ -> ä¸Šè¡£ -> å¸½å­ -> æ¼‚æµ®ç‰©
            // é€™è£¡ä½¿ç”¨ "ç¨‹å¼ç¢¼ç¹ªåœ–" ä½œç‚º fallbackï¼Œå¦‚æœæ‚¨æœ‰åœ–ç‰‡ï¼Œè«‹ç”¨ Image ç‰©ä»¶è¼‰å…¥
            
            drawLayer(ctx, 'base', {id:1}, 0); // ç´ é«”
            drawLayer(ctx, 'bottom', wolfState.bottom, 1);
            drawLayer(ctx, 'shoes', wolfState.shoes, 1); // ç°¡åŒ–
            drawLayer(ctx, 'top', wolfState.top, 1);
            drawLayer(ctx, 'hat', wolfState.hat, 1);
            drawLayer(ctx, 'float', wolfState.float, 1);
        }

        // æ¨¡æ“¬è¼‰å…¥åœ–ç‰‡èˆ‡æŸ“è‰² (è‹¥ç„¡åœ–ç‰‡å‰‡ç•«è‰²å¡Š)
        function drawLayer(ctx, type, item, scale) {
            if (!item || item.id === 0) return;

            const colorHex = (type === 'base') ? '#999' : window.wolfColors[item.color].hex;
            ctx.fillStyle = colorHex;

            // --- é€™è£¡æ˜¯ç”¨ç¨‹å¼ç¢¼ç•«å‡åƒç´  ---
            // å¦‚æœæ‚¨æœ‰åœ–ç‰‡ï¼Œè«‹æŠŠé€™è£¡æ”¹æˆ load image -> drawImage
            // ç‚ºäº†ç¤ºç¯„ï¼Œæˆ‘ç•«ç°¡å–®çš„çŸ©å½¢ä»£è¡¨ä¸åŒéƒ¨ä½
            
            if (type === 'base') {
                // ç•«ä¸€å€‹ç°¡å–®çš„ç‹¼å½¢ç‹€
                ctx.fillStyle = '#ccc'; ctx.fillRect(20, 20, 24, 30); // èº«é«”
                ctx.fillRect(22, 10, 20, 10); // é ­
                ctx.fillStyle = '#333'; ctx.fillRect(25, 14, 2, 2); ctx.fillRect(37, 14, 2, 2); // çœ¼ç›
                ctx.fillStyle = '#ccc'; ctx.fillRect(18, 5, 4, 6); ctx.fillRect(42, 5, 4, 6); // è€³æœµ
                ctx.fillRect(20, 50, 8, 10); ctx.fillRect(36, 50, 8, 10); // è…³
            }
            else if (type === 'top') {
                 // ä¸Šè¡£éš¨æ¬¾å¼è®ŠåŒ–ä¸€é»å½¢ç‹€
                 ctx.fillRect(18, 20, 28, 18); 
                 if(item.id > 3) ctx.fillRect(16, 20, 32, 5); // å¯¬è‚©æ¬¾
            }
            else if (type === 'bottom') {
                 ctx.fillRect(20, 38, 24, 12);
            }
            else if (type === 'hat') {
                 ctx.fillRect(20, 4, 24, 6); // å¸½ç°·
                 ctx.fillRect(22, 0, 20, 4); // å¸½é ‚
                 if(item.id === 6) { ctx.fillStyle="#FFD700"; ctx.fillText("ğŸ‘‘", 24, 0); } // ç‰¹æ®Šæ¬¾
            }
            else if (type === 'shoes') {
                 ctx.fillRect(19, 56, 10, 6); ctx.fillRect(35, 56, 10, 6);
            }
            else if (type === 'float') {
                 const symbols = ["â¤", "!", "â˜…", "â—¡", "zZ", "SOS"];
                 ctx.font = "16px monospace";
                 ctx.fillStyle = colorHex;
                 ctx.fillText(symbols[item.id-1] || "?", 45, 15);
            }
        }

        // --- 4. æŠ½å¡äº’å‹•é‚è¼¯ ---
        
        function startJourney() {
    ensureAudio();

    document.getElementById('center-stage').style.opacity = 0;
    setTimeout(() => {
        document.getElementById('center-stage').style.display = 'none';
    }, 500);

    const crystalsArray = Object.values(window.crystalsData);
    const randomIndex = Math.floor(Math.random() * crystalsArray.length);
    const data = crystalsArray[randomIndex];

    scene.remove(nebulaGroup);

    const dracoLoader = new THREE.DRACOLoader();
    dracoLoader.setDecoderPath(
      'https://www.gstatic.com/draco/versioned/decoders/1.4.3/'
    );

    const loader = new THREE.GLTFLoader();
    loader.setDRACOLoader(dracoLoader);

    const path = `./models/${data.modelFile}`;
    loader.load(path, (gltf) => {
        showResult(gltf.scene, data);
    }, undefined, () => {
        const geo = new THREE.IcosahedronGeometry(2, 0);
        const mat = new THREE.MeshStandardMaterial({ color: 0x88ccff });
        showResult(new THREE.Mesh(geo, mat), data);
    });
}


        function showResult(model, data) {
            isResultMode = true;
            document.body.classList.add('result-mode');
            
            if(currentCrystal) scene.remove(currentCrystal);
            currentCrystal = model;
            
            // èª¿æ•´å¤§å°èˆ‡ä½ç½®
            const box = new THREE.Box3().setFromObject(currentCrystal);
            const size = new THREE.Vector3();
            box.getSize(size);
            const max = Math.max(size.x, size.y, size.z);
            const scale = 5 / max;
            currentCrystal.scale.set(scale, scale, scale);
            
            // RWD ä½ç½®
            if(window.innerWidth > 768) {
                currentCrystal.position.set(-3, 0, 0);
            } else {
                currentCrystal.position.set(0, 1, 0);
            }
            
            scene.add(currentCrystal);
            
            // æ›´æ–°æ–‡å­—é¢æ¿
            const panel = document.getElementById('panel-content');
            panel.innerHTML = `
                <div class="crystal-header">
                    <div class="crystal-theme">${data.theme}</div>
                    <div class="crystal-name">${data.name}</div>
                </div>
                <p>${data.message}</p>
                <hr style="border-color:var(--gold); opacity:0.3; margin: 20px 0;">
                <p><strong>å•å•è‡ªå·±ï¼š</strong><br>${data.question}</p>
                <div style="background:#f9f9f9; padding:15px; border-left:4px solid var(--gold); margin-top:20px;">
                    <em>${data.action}</em>
                </div>
                <p style="font-size:0.9rem; color:#666; margin-top:10px;">${data.subAction}</p>
            `;
            
            // æ”å½±æ©Ÿå‹•ç•«
            camera.position.set(0, 0, 15);
        }

        function resetApp() {
            isResultMode = false;
            document.body.classList.remove('result-mode');
            if(currentCrystal) scene.remove(currentCrystal);
            
            scene.add(nebulaGroup);
            camera.position.set(0, 0, 25);
            controls.autoRotate = true;
            
            const stage = document.getElementById('center-stage');
            stage.style.display = 'flex';
            setTimeout(() => { stage.style.opacity = 1; }, 100);
        }

        // --- 5. è¡£æ«ƒ UI é‚è¼¯ ---
        function openWardrobe() {
            const modal = document.getElementById('wardrobe-modal');
            modal.style.display = 'flex';
            renderTabs();
            renderGrid('hat'); // é è¨­é¡¯ç¤ºå¸½å­
        }

        function closeWardrobe() {
            document.getElementById('wardrobe-modal').style.display = 'none';
        }

        function renderTabs() {
            const tabs = document.getElementById('wardrobe-tabs');
            tabs.innerHTML = '';
            Object.keys(window.wolfParts).forEach(key => {
                const btn = document.createElement('button');
                btn.className = 'tab-btn';
                btn.innerText = window.wolfParts[key].label;
                btn.onclick = (e) => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    renderGrid(key);
                };
                tabs.appendChild(btn);
            });
            tabs.children[0].classList.add('active');
        }

        function renderGrid(type) {
            const grid = document.getElementById('wardrobe-grid');
            grid.innerHTML = '';
            
            // ç”Ÿæˆè©²é¡åˆ¥çš„æ‰€æœ‰å¯èƒ½çµ„åˆ (6æ¬¾ * 10è‰²)
            const partInfo = window.wolfParts[type];
            
            // å…ˆåŠ å…¥ã€Œè„«ä¸‹ã€é¸é …
            const removeBtn = document.createElement('div');
            removeBtn.className = 'wardrobe-item';
            removeBtn.innerText = "âŒ";
            removeBtn.onclick = () => {
                wolfState[type] = { id: 0, color: 0 };
                saveWolfData();
                drawWolf();
                renderGrid(type);
            };
            grid.appendChild(removeBtn);

            for(let i=1; i<=partInfo.count; i++) {
                window.wolfColors.forEach((color, colorIdx) => {
                    const itemKey = `${type}_${i}_${colorIdx}`;
                    const isUnlocked = wolfState.inventory.includes(itemKey);
                    
                    const div = document.createElement('div');
                    div.className = `wardrobe-item ${isUnlocked ? '' : 'locked'}`;
                    
                    // å¦‚æœæ­£åœ¨ç©¿è‘—
                    if(wolfState[type].id === i && wolfState[type].color === colorIdx) {
                        div.classList.add('active');
                    }

                    // è¦–è¦ºå‘ˆç¾ (è‰²é» + ID)
                    div.innerHTML = `<span style="font-size:0.6rem; color:#fff;">${i}</span>`;
                    const dot = document.createElement('div');
                    dot.className = 'color-dot';
                    dot.style.backgroundColor = color.hex;
                    div.appendChild(dot);

                    if(isUnlocked) {
                        div.onclick = () => {
                            wolfState[type] = { id: i, color: colorIdx };
                            saveWolfData();
                            drawWolf(); // æ›´æ–°å°ç‹¼é¡¯ç¤º
                            renderGrid(type); // æ›´æ–°é¸ä¸­ç‹€æ…‹
                        };
                    }

                    grid.appendChild(div);
                });
            }
        }

        // --- 6. éŸ³æ¨‚æ§åˆ¶ ---
        function toggleAudio() {
            const audio = document.getElementById('bgm');
            const btn = document.querySelector('.audio-btn');
            if(audio.paused) {
                audio.play();
                audioPlaying = true;
                btn.innerText = "ğŸµ Music: ON";
                btn.style.borderColor = "#fff";
                btn.style.color = "#fff";
            } else {
                audio.pause();
                audioPlaying = false;
                btn.innerText = "ğŸµ Music: OFF";
                btn.style.borderColor = "var(--gold)";
                btn.style.color = "var(--gold)";
            }
        }
        
        function ensureAudio() {
            // ç”¨æˆ¶äº’å‹•å¾Œå˜—è©¦æ’­æ”¾ (å¦‚æœä¹‹å‰æ²’é–‹çš„è©±)
            if(!audioPlaying) {
                 // é€™è£¡å¯ä»¥é¸æ“‡å¼·åˆ¶é–‹å•Ÿï¼Œæˆ–è€…å°Šé‡ç”¨æˆ¶é¸æ“‡ã€‚
                 // é€šå¸¸å»ºè­°ä¸è¦åœ¨é»æ“Šå…¶ä»–æŒ‰éˆ•æ™‚å¼·åˆ¶æ’­æ”¾ï¼Œé™¤éæ˜¯ç”¨æˆ¶æ˜ç¢ºé»æ“Šäº† Playã€‚
            }
        }

        // --- 7. å…¶ä»– ---
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            
            if(!isResultMode) {
                // æ˜Ÿé›²è‡ªè½‰
                nebulaGroup.rotation.y += 0.001;
                // æ°´æ™¶è‡ªè½‰
                crystals.forEach(c => {
                    c.rotation.x += 0.005;
                    c.rotation.y += 0.005;
                });
            } else if(currentCrystal) {
                currentCrystal.rotation.y += 0.002;
            }

            renderer.render(scene, camera);
        }

        // å•Ÿå‹•
        init();

    </script>
</body>
</html>
